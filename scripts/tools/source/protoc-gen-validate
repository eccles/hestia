#
# Installs protoc_gen_validate
#
# This file is sourced
#
. ./scripts/source/log
. ./scripts/source/environment
. ./scripts/tools/source/common

# if you want to upgrade then chenge this value AND delete $(which protoc-gen-validate)
# and remove the entry for protoc-gen-validate from go.mod
PROTOC_GEN_VALIDATE_VERSION=0.6.3
PROTOC_GEN_VALIDATE_CMD=protoc-gen-validate
URL=github.com/envoyproxy/protoc-gen-validate
INDIR="${HOME}/go/pkg/mod/${URL}@v${PROTOC_GEN_VALIDATE_VERSION}/validate/"
OUTDIR="${HOME}/.local/include/${URL}/"

# protoc-gen-validate is old-fashioned and changes the go.mod file - which
# it should not do when the version is specified on te go install command
protoc-gen-validate_install() {
	log_info "Installing ${PROTOC_GEN_VALIDATE_CMD} ${PROTOC_GEN_VALIDATE_VERSION}"
	go install -v github.com/envoyproxy/${PROTOC_GEN_VALIDATE_CMD}@v${PROTOC_GEN_VALIDATE_VERSION}
	# make proto files accessible to protoc
	mkdir -p "${OUTDIR}"
	cp -r "${INDIR}" "${OUTDIR}"
	chmod -R +rwx "${OUTDIR}"
}
